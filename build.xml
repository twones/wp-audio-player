<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="Audio Player WordPress plugin" basedir="." default="deploy.default">
	<taskdef name="jsmin" classname="net.matthaynes.jsmin.JSMin_Task" classpath="${ant.library.dir}/jsmin.0.2.2.jar"/>
	<taskdef resource="net/sf/antcontrib/antlib.xml" classpath="${ant.library.dir}/ant-contrib-1.0b3.jar"/>
	
	<property name="build" value="build"/>
	<property name="dist" value="dist"/>

	<property file="build.properties"/>

	<property name="swfcompile.jsfl" value="${basedir}/swfcompile.jsfl"/>
	
	<target name="init" depends="clean">
		<mkdir dir="${build}"/>
		<mkdir dir="${dist}"/>
	</target>

	<target name="clean" description="Clean up">
		<delete dir="${build}"/>
		<delete dir="${dist}"/>
		<delete file="swfcompile.jsfl"/>
	</target>

	<target name="deploy.to.all" depends="build" description="Deploy to all local test sites">
		<foreach target="deploy" param="deploy.dir">
			<path>
				<dirset dir="${deploy.path}" includes="wp*"/>
			</path>
		</foreach>
		<antcall target="clean"/>
	</target>

	<target name="deploy.to" depends="build" description="Deploy to one local test site">
		<input message="Please select test site to deploy to:" addproperty="wp.version" defaultvalue="wp23"/>
		<antcall target="deploy">
			<param name="deploy.dir" value="${deploy.path}/${wp.version}"/>
		</antcall>
		<antcall target="clean"/>
	</target>

	<target name="deploy.default" depends="build" description="Deploy to default local test site">
		<antcall target="deploy">
			<param name="deploy.dir" value="${deploy.path}/${default.deploy.version}"/>
		</antcall>
		<antcall target="clean"/>
	</target>

	<target name="deploy">
		<delete dir="${deploy.dir}/wp-content/plugins/audio-player"/>
		<unzip src="${dist}/audio-player.zip" dest="${deploy.dir}/wp-content/plugins/audio-player" overwrite="true"/>
	</target>

	<target name="build" depends="init" description="Build plugin archive">
		<copy todir="${build}">
			<fileset dir="./plugin">
				<include name="**/*.*"/>
				<exclude name="**/graphics-source.png"/>
				<exclude name="**/mootools.js"/>
				<exclude name="**/*.po"/>
				<exclude name="**/*.back"/>
			</fileset>
		</copy>
		<move file="${build}/assets/lib/mootools-compressed.js" tofile="${build}/assets/lib/mootools.js"/>
		
		<condition property="swfExists">
	    	<available file="source/player.swf"/>
	    </condition>
		
		<antcall target="compileIfMissing"/>
		
		<copy todir="${build}/assets" file="source/player.swf"/>
		
		<!-- Minify JavaScript files (except mootools) -->
		<jsmin force="true">
			<fileset dir="${build}" includes="**/*.js" excludes="**/mootools*"/>
		</jsmin>
		
		<zip destfile="${dist}/audio-player.zip" basedir="${build}"/>
	</target>
	
	<target name="compileIfMissing" unless="swfExists">
		<antcall target="compile"/>
	</target>
		
	<target name="compile" description="Compile swf player">
		<filter token="sourceFile" value="file:///${basedir}/source/player.fla"/>
		<filter token="destFile" value="file:///${basedir}/source/player.swf"/>
		<copy file="swfcompile.template" tofile="swfcompile.jsfl" filtering="true"/>
		<replaceregexp file="swfcompile.jsfl" match="\\" replace="/" flags="g"/>
	    <exec executable="${flash.exe}">
	        <arg line="'${swfcompile.jsfl}'"/>
	    </exec>
	</target>
	
</project>